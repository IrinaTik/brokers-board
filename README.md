# Приложение "Валютная биржа"

![Java](https://img.shields.io/badge/-Java-0a0a0a?style=for-the-badge&logo=Java)
![Spring Boot](https://img.shields.io/badge/-springboot-0a0a0a?style=for-the-badge&logo=springboot)
![Spring JPA](https://img.shields.io/badge/-springjpa-0a0a0a?style=for-the-badge&logo=springjpa)
![H2](https://img.shields.io/badge/-H2-0a0a0a?style=for-the-badge&logo=H2)
![Jackson](https://img.shields.io/badge/-Jackson-0a0a0a?style=for-the-badge&logo=Jackson)
![Lombok](https://img.shields.io/badge/-Lombok-0a0a0a?style=for-the-badge&logo=Lombok)

#Содержание
- [Описание проекта](#описание-проекта)
- [Сценарии использования](#сценарии-использования)
- [Логика работы приложения](#логика-работы-приложения)
    * [Модель данных](#модель-данных)
    * [Работа с валютами](#работа-с-валютами)
    * [Работа с курсами валют](#работа-с-курсами-валют)
      + [Специфика расчета курса валют](#специфика-расчета-курса-валют)
- [Требования по разработке](#требования-по-разработке)

## Описание проекта
Приложение "Валютная биржа" предназначена для хранения, записи и предоставления по требованию
информации о валютах и валютных курсах. 

В основе приложения заложены два понятия: валюта и курс валюты.

Валюта - это денежная единица какой-либо страны. 
В рамках приложения характеризуется следующими элементами:
- название валюты (Американский доллар, российский рубль и тд)
- код валюты (USD, RUB и тд)
- орган, ответственный за эмиссию (выпуск) данной валюты.

Курс валюты - это стоимость валюты одной страны в валютах других стран.
В рамках приложения характеризуется следующими элементами:
- валютная пара (две валюты, используемых в обменном курсе, например Рубль\Доллар)
- дата обменного курса (одна и та же валютная пара в разные дни может иметь разный обменный курс)
- сам обменный курс, значение первой указанной валюты в единицах второй указанной валюты

При запуске приложения данные о валютах и курсах, записанные в файл data.sql,
сохраняются в базе данных и выводятся в консоль.

Работа с приложением осуществляется через REST эндпойты.
Можно получить следующие данные:
- информация о всех содержащихся в БД валютах
- информация о конкретной валюте по ее буквенному коду
- информация о всех содержащихся в БД курсах валют
- информация о конкретном курсе по буквенным кодам ее валют и дате курса

При отсутствии запрашиваемых данных о валютных курсах приложение обращается 
к сайту Центрального Банка РФ, после чего записывает полученные данные в БД.

## Сценарии использования
Приложение поддерживает следующие REST-endpoints:

1. /currencies - список всех содержащихся в БД валют.

   Для каждой валюты выдается следующая информация:
   - номер записи в БД
   - название
   - буквенный код
   - организация, ответственная за эмиссию валюты

   Этот список не может быть пустым, так как при запуске приложения в БД загружаются
   по умолчанию данные из файла data.sql

2. currencies/`CODE` - валюта с буквенным кодом `CODE`

   Информация, выдаваемая по валюте:
   - номер записи в БД
   - название
   - буквенный код
   - организация, ответственная за эмиссию валюты

   В случае, если валюта с указанным кодом не найдена в БД, будет выведено
   сообщение `404 Not found`.
3. /rates - список всех содержащихся в БД курсов валют

   Для каждого курса валют выдается следующая информация:
   - номер записи в БД
   - информация по первой валюте
   - информация по второй валюте
   - единицы первой валюты
   - история курса первой валюты

   Под историей курса подразумевается список значений курса валют по
   определенным датам. В рамках истории курса выдается следующая информация:
   - номер записи в БД
   - дата, на которую зафиксирован данный курс
   - значение второй валюты

   История курса не может быть пустым список - запись хотя бы за одну дату
   обязательно будет присутствовать.

4. /rates/`ID` - курс валют с номером в БД `ID`

   Информация, выдаваемая по курсу валют:
   - номер записи в БД
   - информация по первой валюте
   - информация по второй валюте
   - единицы первой валюты
   - история курса первой валюты

   Под историей курса подразумевается список значений курса валют по
   определенным датам. В рамках истории курса выдается следующая информация:
   - номер записи в БД
   - дата, на которую зафиксирован данный курс
   - значение второй валюты

   История курса не может быть пустым список - запись хотя бы за одну дату
   обязательно будет присутствовать.

5. /rates/`CODE1`/`CODE2`/`DATE` - курс валют `CODE1`/`CODE2`, т.е. цена валюты с
   буквенным кодом `CODE1` в денежных единицах валюты с буквенным кодом `CODE2` на
   дату `DATE`.

   **Формат даты должен быть `YYYY-MM-DD`**

   Информация, выдаваемая по курсу валют:
   - номер записи в БД
   - информация по первой валюте
   - информация по второй валюте
   - единицы первой валюты
   - значение второй валюты
   - дата, на которую зафиксирован данный курс

   Если хотя бы один из указанных кодов валют не найден ни в БД, ни на сайте Центрального Банка РФ,
   то будет выведено сообщение `400 Invalid currency code`.

## Логика работы приложения
### Модель данных

В модель данных включены три сущности:
- ВАЛЮТА
- КУРС_ВАЛЮТ
- ИСТОРИЯ_КУРСА_ВАЛЮТ

Сущность ВАЛЮТА представлена
- в БД таблицей CURRENCIES
- в проекте классом Currency

|                Поле                     | Поле в классе проекта | Поле в таблице БД |
| ----------------------------------------|:---------------------:| -----------------:|
| Идентификатор                           |          id           |         id        |
| Название валюты                         |         name          |        name       |
| Буквенный код валюты                    |         code          |        code       |
| Организация, ответственная за эмиссию   |          org          |         org       |

Сущность КУРС_ВАЛЮТ представлена
- в БД таблицей EXCHANGE_RATES
- в проекте классом ExchangeRate

|                Поле                     | Поле в классе проекта | Поле в таблице БД  |
| ----------------------------------------|:---------------------:| ------------------:|
| Идентификатор                           |          id           |         id         |
| Информация о первой валюте              |    firstCurrency      |  first_currency_id |
| Информация о второй валюте              |    secondCurrency     | second_currency_id |
| Единица первой валюты                   |  firstCurrencyValue   |first_currency_value|
| История курса  						  |      history          |         -          |


Сущность ИСТОРИЯ_КУРСА_ВАЛЮТ представлена
- в БД таблицей EXCHANGE_RATE_HISTORY
- в проекте классом ExchangeRateHistory

|                Поле                         | Поле в классе проекта | Поле в таблице БД |
| --------------------------------------------|:---------------------:| -----------------:|
| Идентификатор                      	      |          id           |         id        |
| Курс валют, к которому относится эта история|         rate          |  	  rate_id     |
| Дата курса      					          |         date          |      date_time    |
| Значение второй валюты                      |     currencyValue     |   currency_value  |

Сущность ВАЛЮТА связана с сущностью КУРС_ВАЛЮТ связью OneToOne в полях "Информация о первой валюте"
и "Информация о второй валюте ".

Сущность КУРС_ВАЛЮТ связана с сущностью ИСТОРИЯ_КУРСА_ВАЛЮТ связью OneToMany в поле "История курса".

Сущность ИСТОРИЯ_КУРСА_ВАЛЮТ связана с сущностью КУРС_ВАЛЮТ связью ManyToOne в поле 
"Курс валют, к которому относится эта история".

### Работа с валютами
При запросе валюты по буквенному коду:
- валюты с указанным кодом найдена в БД -> выдается информация о ней
- валюты с указанным кодом нет в БД -> выдается сообщение `404 Not found`

### Работа с курсами валют
При запросе курса валют по двум буквенным кодам валют и дате сначала 
происходит проверка валидности даты по следующим критериям:
- формат даты YYYY-MM-DD
- нет аномалий, например указан 13й месяц
- дата не раньше 1 июля 1992 года - это самая первая дата в архиве Центрального Банка РФ

Если дата не валидна, то выдается сообщение `400 Invalid date`

Если же с датой все в порядке, следующей происходит проверка, есть ли валюты с указанными кодами в БД. 
Если в БД их нет, то приложение обращается к сайту Центрального Банка РФ, адрес которого имеет вид 
`https://www.cbr-xml-daily.ru//archive//YYYY//MM//DD//daily_json.js`.

Если код какой-либо валюты не найден ни в БД, ни на сайте ЦБ РФ, то выдается сообщение
`400 Invalid currency code`. 

Если валют нет в БД, но есть на сайте ЦБ РФ, то информация об этих валютах заносится в БД. Далее
приложение формирует информацию о курсе, выдает ее и, кроме этого, заносит ее в БД.

Если валюты есть в БД, то учитывая механизм занесения валют в БД, курс в БД уже есть.
Вопрос в том, есть ли запись в истории этого курса за указанную дату.
Если есть, то приложение выдает ее. Если нет, то приложение обращается к сайту ЦБ РФ, 
дополняет историю курса за указанную дату, выдает эту информацию и сохраняет ее в БД.

#### Специфика расчета курса валют
Так как на сайте ЦБ РФ все курсы указаны по отношению к рублю, то возникает необходимость
дополнительных расчетов.

С учетом вышесказанного есть три варианта, как может выглядеть курс валют:
1. RUB \ ВАЛЮТА
   
   В этом случае значение курса рассчитывается по формуле `1 / (значение валюты * номинал валюты)`

2. ВАЛЮТА \ RUB

   В этом случае значение курса никак не пересчитывается, а берется с сайта ЦБ РФ в неизмененном виде

3. ВАЛЮТА_1 \ ВАЛЮТА_2, где ни одна из них не является рублем

   В этом случае значение курса рассчитывается по формуле 
`(значение валюты 1 * номинал валюты 2) / (значение валюты 2 * номинал валюты 1)`




## Требования по разработке
Были поставлены следующие требования к проекту:
- В основе проекта Spring Boot
- Гетеры, сетеры, конструкторы объявить через Lombok
- Для конфигурации приложения использовать только аннотации
- Использовать MapStruct для преобразования сущностей
- Использовать БД H2 для хранения информации
- При запуске проекта заполнить БД некоторыми данными через скрипт и вывести их на консоль
